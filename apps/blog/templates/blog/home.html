<!doctype html>
<html lang="ko">
<head>
  {% load static %}
  <link rel="icon" type="image/svg+xml" href="{% static 'blog/favicon.svg' %}">
  <link rel="icon" sizes="any" href="{% static 'blog/favicon.svg' %}">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DongriGo: 아는 만큼 보이는 세계여행!</title>

  <link rel="stylesheet" href="{% static 'blog/css/pygments.css' %}">
  <link rel="stylesheet" href="{% static 'blog/css/codehilite_extra.css' %}">
  <link rel="stylesheet" href="{% static 'blog/css/site.css' %}">
  <link rel="stylesheet" href="{% static 'blog/vendor/flag-icons/css/flag-icons.min.css' %}">
</head>

<body>
  <div class="wrap {% if selected_country %}has-board{% else %}no-board{% endif %}"
       data-has-board="{% if selected_country %}1{% else %}0{% endif %}">

    <!-- LEFT: Globe -->
    <div class="globe" id="globeArea"
         data-selected-country-slug="{% if selected_country %}{{ selected_country.slug }}{% endif %}">
      <div class="globe-shell">
        <div id="globeMount" class="globe-mount" aria-label="Interactive globe"></div>

        <div class="globe-overlay" aria-label="Globe controls">
          <div class="overlay-inner">
            <div class="globe-title">Dongri Go</div>

            <div class="search-wrap">
              <input id="countrySearch" class="country-search" type="text"
                     placeholder="국가 검색 (예: Korea, Japan)" />

              <div class="country-list" id="countryList">
                {% for c in countries %}
                  <a class="country-link {% if selected_country and selected_country.slug == c.slug %}active{% endif %}"
                     href="/{{ c.slug }}/"
                     hx-get="/{{ c.slug }}/"
                     hx-target="#boardContent"
                     hx-swap="innerHTML"
                     hx-indicator=".htmx-indicator"
                     hx-push-url="true">
                    {{ c.name }}
                  </a>
                {% empty %}
                  <div class="hint">/admin에서 Country를 먼저 추가하세요.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- HTMX trigger (단 1개) -->
        <a
          id="globeSelectLink"
          href="/"
          hx-get="/"
          hx-target="#boardContent"
          hx-swap="innerHTML"
          hx-indicator=".htmx-indicator"
          hx-push-url="true"
          style="display:none"
        ></a>
      </div>
    </div>

    <!-- RIGHT: Board (stable shell + swappable content) -->
    <div class="board" id="board">
      <!-- swipe edge handle -->
      <div class="board-swipe-edge" id="boardSwipeEdge" aria-hidden="true"></div>

      <div id="boardContent" class="board-content" hx-history-elt>
        {% include "blog/_board.html" %}
      </div>

      <!-- Loading overlay (skeleton) -->
      <div class="board-overlay board-overlay--loading" id="boardLoading" hidden aria-hidden="true">
        <div class="board-skeleton" aria-label="Loading">
          <div class="sk-row">
            <div class="sk-line sk-70"></div>
            <div class="sk-line sk-40"></div>
          </div>

          <div class="sk-spacer"></div>

          <div class="sk-row">
            <div class="sk-chip"></div>
            <div class="sk-chip"></div>
            <div class="sk-chip"></div>
          </div>

          <div class="sk-spacer"></div>

          <div class="sk-row sk-col">
            <div class="sk-line"></div>
            <div class="sk-line"></div>
            <div class="sk-line sk-85"></div>
            <div class="sk-line sk-60"></div>
            <div class="sk-line sk-75"></div>
          </div>

          <div class="sk-spacer"></div>

          <div class="sk-row sk-col">
            <div class="sk-card"></div>
            <div class="sk-card"></div>
            <div class="sk-card"></div>
          </div>
        </div>
      </div>

      <!-- Error overlay -->
      <div class="board-overlay board-overlay--error" id="boardError" hidden aria-hidden="true" role="alert">
        <div class="board-error-box">
          <div class="board-error-title">보드를 불러오지 못했습니다</div>
          <div class="hint">네트워크 또는 서버 오류로 요청이 실패했습니다.</div>
          <div class="board-error-actions">
            <button class="btn" type="button" id="boardRetryBtn">다시 시도</button>
            <a class="btn js-close" href="/" id="boardGoHomeBtn">홈</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Dim overlay -->
    <div class="board-dim" id="boardDim" aria-hidden="true"></div>

    <!-- HTMX indicator -->
    <div class="htmx-indicator">불러오는 중...</div>
  </div>

  <!-- vendor -->
  <script src="{% static 'blog/vendor/htmx/htmx.min.js' %}"></script>
  <script src="{% static 'blog/vendor/topojson/topojson.min.js' %}"></script>
  <script src="{% static 'blog/vendor/globe.gl/globe.gl.min.js' %}"></script>

  <!-- Django -> JS -->
  {{ countries_for_globe|json_script:"globeCountriesData" }}

  <!-- assets -->
  <script>
    window.TRAVEL_ATLAS_ASSETS = {
      topojsonUrl: "{% static 'blog/vendor/world-atlas/countries-110m.json' %}",
      earthTextureUrl: "{% static 'blog/vendor/three-globe/earth-dark.jpg' %}"
    };
  </script>

  <!-- Board state manager (여기서 보드 상태 전담) -->
  <script src="{% static 'blog/js/board_state.js' %}"></script>

  <!-- Search UX -->
  <script src="{% static 'blog/js/search_ux.js' %}"></script>

  <!-- Globe integration -->
  <script src="{% static 'blog/js/globe.js' %}"></script>
  <script src="{% static 'blog/js/lightbox.js' %}"></script>

  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div>
      <div class="lb-loading" aria-hidden="true">
        <div class="lb-spinner"></div>
      </div>

      <img id="lightboxImg" alt="" />
      <div class="hint" id="lightboxCap"></div>
    </div>
  </div>
</body>
</html>
