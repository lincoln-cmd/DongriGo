<!doctype html>
<html lang="ko">
<head>
  {% load static %}
  <meta charset="utf-8" />
  <title>DongriGo: 아는 만큼 보이는 세계여행!</title>

  <link rel="stylesheet" href="{% static 'blog/css/pygments.css' %}">
  <link rel="stylesheet" href="{% static 'blog/css/codehilite_extra.css' %}">
  <link rel="stylesheet" href="{% static 'blog/css/site.css' %}">
  <link rel="stylesheet" href="{% static 'blog/vendor/flag-icons/css/flag-icons.min.css' %}">
</head>

<body>
  <div class="wrap no-board" data-has-board="{% if selected_country %}1{% else %}0{% endif %}">
    <!-- LEFT: Globe -->
    <div class="globe" id="globeArea" data-selected-country-slug="{% if selected_country %}{{ selected_country.slug }}{% endif %}">
      <div class="globe-shell">
        <div id="globeMount" class="globe-mount" aria-label="Interactive globe"></div>

        <div class="globe-overlay" aria-label="Globe controls">
          <div class="overlay-inner">
            <div class="globe-title">Dongri Go</div>

            <div class="search-wrap">
              <input id="countrySearch" class="country-search" type="text" placeholder="국가 검색 (예: Korea, Japan)" />

              <div class="country-list" id="countryList">
                {% for c in countries %}
                  <a class="country-link {% if selected_country and selected_country.slug == c.slug %}active{% endif %}"
                     href="/{{ c.slug }}/">
                    {{ c.name }}
                  </a>
                {% empty %}
                  <div class="hint">/admin에서 Country를 먼저 추가하세요.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- HTMX trigger (단 1개) -->
        <a
          id="globeSelectLink"
          href="/"
          hx-get="/"
          hx-target="#boardContent"
          hx-swap="innerHTML"
          hx-indicator=".htmx-indicator"
          hx-push-url="true"
          style="display:none"
        ></a>
      </div>
    </div>

    <!-- RIGHT: Board (stable shell + swappable content) -->
    <div class="board" id="board">
      <div id="boardContent" class="board-content">
        {% include "blog/_board.html" %}
      </div>

      <!-- Loading overlay (skeleton) -->
      <div class="board-overlay board-overlay--loading" id="boardLoading" hidden aria-hidden="true">
        <div class="board-skeleton" aria-label="Loading">
          <div class="sk-row">
            <div class="sk-line sk-70"></div>
            <div class="sk-line sk-40"></div>
          </div>

          <div class="sk-spacer"></div>

          <div class="sk-row">
            <div class="sk-chip"></div>
            <div class="sk-chip"></div>
            <div class="sk-chip"></div>
          </div>

          <div class="sk-spacer"></div>

          <div class="sk-row sk-col">
            <div class="sk-line"></div>
            <div class="sk-line"></div>
            <div class="sk-line sk-85"></div>
            <div class="sk-line sk-60"></div>
            <div class="sk-line sk-75"></div>
          </div>

          <div class="sk-spacer"></div>

          <div class="sk-row sk-col">
            <div class="sk-card"></div>
            <div class="sk-card"></div>
            <div class="sk-card"></div>
          </div>
        </div>
      </div>

      <!-- Error overlay -->
      <div class="board-overlay board-overlay--error" id="boardError" hidden aria-hidden="true" role="alert">
        <div class="board-error-box">
          <div class="board-error-title">보드를 불러오지 못했습니다</div>
          <div class="hint">네트워크 또는 서버 오류로 요청이 실패했습니다.</div>
          <div class="board-error-actions">
            <button class="btn" type="button" id="boardRetryBtn">다시 시도</button>
            <a class="btn" href="/" id="boardGoHomeBtn">홈</a>
          </div>
        </div>
      </div>
    </div>

    <!-- 기존 HTMX indicator(토스트용)는 유지 -->
    <div class="htmx-indicator">불러오는 중...</div>
  </div>

  <!-- ✅ vendor -->
  <script src="{% static 'blog/vendor/htmx/htmx.min.js' %}"></script>
  <script src="{% static 'blog/vendor/topojson/topojson.min.js' %}"></script>
  <script src="{% static 'blog/vendor/globe.gl/globe.gl.min.js' %}"></script>

  <!-- Django -> JS -->
  {{ countries_for_globe|json_script:"globeCountriesData" }}

  <!-- ✅ Django -> JS (assets): TopoJSON-only -->
  <script>
    window.TRAVEL_ATLAS_ASSETS = {
      topojsonUrl: "{% static 'blog/vendor/world-atlas/countries-110m.json' %}",
      earthTextureUrl: "{% static 'blog/vendor/three-globe/earth-dark.jpg' %}"
    };
  </script>

  <script>
    (function () {
      const board = document.getElementById("board");
      const content = document.getElementById("boardContent");
      if (!board || !content) return;

      function syncReadingMode() {
        const marker = content.querySelector("[data-has-post='1']");
        if (marker) board.classList.add("reading");
        else board.classList.remove("reading");
      }

      document.addEventListener("DOMContentLoaded", syncReadingMode);

      document.body.addEventListener("htmx:afterSwap", (e) => {
        if (e.target && e.target.id === "boardContent") {
          syncReadingMode();
        }
      });
    })();

    (function () {
      const wrap = document.querySelector(".wrap");
      if (!wrap) return;

      document.addEventListener("DOMContentLoaded", () => {
        if (wrap.dataset.hasBoard === "1") {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              wrap.classList.remove("no-board");
              wrap.classList.add("has-board");
            });
          });
        }
      });

      const input = document.getElementById("countrySearch");
      const list = document.getElementById("countryList");

      if (input && list) {
        const filter = () => {
          const q = input.value.trim().toLowerCase();
          list.classList.toggle("has-query", q.length > 0);

          const links = list.querySelectorAll("a.country-link");
          links.forEach(a => {
            const name = (a.textContent || "").trim().toLowerCase();
            a.style.display = name.includes(q) ? "" : "none";
          });
        };

        input.addEventListener("input", filter);
        input.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            input.value = "";
            filter();
            input.blur();
          }
        });

        filter();
      }

      document.addEventListener("click", (e) => {
        const close = e.target.closest && e.target.closest("a.close-btn");
        if (!close) return;

        e.preventDefault();
        wrap.classList.add("closing");
        wrap.classList.remove("has-board");
        wrap.classList.add("no-board");

        setTimeout(() => {
          wrap.classList.remove("closing");
          window.location.href = close.getAttribute("href") || "/";
        }, 260);
      });
    })();
  </script>

  <!-- Board state manager (NEW) -->
  <script src="{% static 'blog/js/board_state.js' %}"></script>

  <!-- Globe integration -->
  <script src="{% static 'blog/js/globe.js' %}"></script>
  <script src="{% static 'blog/js/lightbox.js' %}"></script>

  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div>
      <div class="lb-loading" aria-hidden="true">
        <div class="lb-spinner"></div>
      </div>

      <img id="lightboxImg" alt="" />
      <div class="hint" id="lightboxCap"></div>
    </div>
  </div>
</body>
</html>
