<!doctype html>
<html lang="ko">
<head>
  {% load static %}
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DongriGo: 아는 만큼 보이는 세계여행!</title>

  <link rel="stylesheet" href="{% static 'blog/css/pygments.css' %}">
  <link rel="stylesheet" href="{% static 'blog/css/codehilite_extra.css' %}">
  <link rel="stylesheet" href="{% static 'blog/css/site.css' %}">
  <link rel="stylesheet" href="{% static 'blog/vendor/flag-icons/css/flag-icons.min.css' %}">
  <link rel="icon" type="image/svg+xml" href="{% static 'blog/favicon.svg' %}">
  <link rel="icon" sizes="any" href="{% static 'blog/favicon.svg' %}">

</head>

<body>
  <div class="wrap no-board" data-has-board="{% if selected_country %}1{% else %}0{% endif %}">
    <!-- LEFT: Globe -->
    <div class="globe" id="globeArea" data-selected-country-slug="{% if selected_country %}{{ selected_country.slug }}{% endif %}">
      <div class="globe-shell">
        <div id="globeMount" class="globe-mount" aria-label="Interactive globe"></div>

        <div class="globe-overlay" aria-label="Globe controls">
          <div class="overlay-inner">
            <div class="globe-title">Dongri Go</div>

            <div class="search-wrap">
              <input id="countrySearch" class="country-search" type="text" placeholder="국가 검색 (예: Korea, Japan)" />

              <div class="country-list" id="countryList">
                {% for c in countries %}
                  <a class="country-link {% if selected_country and selected_country.slug == c.slug %}active{% endif %}"
                     href="/{{ c.slug }}/">
                    {{ c.name }}
                  </a>
                {% empty %}
                  <div class="hint">/admin에서 Country를 먼저 추가하세요.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- HTMX trigger (단 1개) -->
        <a
          id="globeSelectLink"
          href="/"
          hx-get="/"
          hx-target="#boardContent"
          hx-swap="innerHTML"
          hx-indicator=".htmx-indicator"
          hx-push-url="true"
          style="display:none"
        ></a>
      </div>
    </div>

    <!-- RIGHT: Board (stable shell + swappable content) -->
    <div class="board" id="board">
      <!-- ✅ swipe edge handle -->
      <div class="board-swipe-edge" id="boardSwipeEdge" aria-hidden="true"></div>

      <div id="boardContent" class="board-content">
        {% include "blog/_board.html" %}
      </div>

      <!-- Loading overlay (skeleton) -->
      <div class="board-overlay board-overlay--loading" id="boardLoading" hidden aria-hidden="true">
        <div class="board-skeleton" aria-label="Loading">
          <div class="sk-row">
            <div class="sk-line sk-70"></div>
            <div class="sk-line sk-40"></div>
          </div>

          <div class="sk-spacer"></div>

          <div class="sk-row">
            <div class="sk-chip"></div>
            <div class="sk-chip"></div>
            <div class="sk-chip"></div>
          </div>

          <div class="sk-spacer"></div>

          <div class="sk-row sk-col">
            <div class="sk-line"></div>
            <div class="sk-line"></div>
            <div class="sk-line sk-85"></div>
            <div class="sk-line sk-60"></div>
            <div class="sk-line sk-75"></div>
          </div>

          <div class="sk-spacer"></div>

          <div class="sk-row sk-col">
            <div class="sk-card"></div>
            <div class="sk-card"></div>
            <div class="sk-card"></div>
          </div>
        </div>
      </div>

      <!-- Error overlay -->
      <div class="board-overlay board-overlay--error" id="boardError" hidden aria-hidden="true" role="alert">
        <div class="board-error-box">
          <div class="board-error-title">보드를 불러오지 못했습니다</div>
          <div class="hint">네트워크 또는 서버 오류로 요청이 실패했습니다.</div>
          <div class="board-error-actions">
            <button class="btn" type="button" id="boardRetryBtn">다시 시도</button>
            <a class="btn" href="/" id="boardGoHomeBtn">홈</a>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ Dim overlay (mobile polish) -->
    <div class="board-dim" id="boardDim" aria-hidden="true"></div>

    <!-- 기존 HTMX indicator(토스트용)는 유지 -->
    <div class="htmx-indicator">불러오는 중...</div>
  </div>

  <!-- ✅ vendor -->
  <script src="{% static 'blog/vendor/htmx/htmx.min.js' %}"></script>
  <script src="{% static 'blog/vendor/topojson/topojson.min.js' %}"></script>
  <script src="{% static 'blog/vendor/globe.gl/globe.gl.min.js' %}"></script>

  <!-- Django -> JS -->
  {{ countries_for_globe|json_script:"globeCountriesData" }}

  <!-- ✅ Django -> JS (assets): TopoJSON-only -->
  <script>
    window.TRAVEL_ATLAS_ASSETS = {
      topojsonUrl: "{% static 'blog/vendor/world-atlas/countries-110m.json' %}",
      earthTextureUrl: "{% static 'blog/vendor/three-globe/earth-dark.jpg' %}"
    };
  </script>

  <script>
    (function () {
      const board = document.getElementById("board");
      const content = document.getElementById("boardContent");
      if (!board || !content) return;

      function syncReadingMode() {
        const marker = content.querySelector("[data-has-post='1']");
        if (marker) board.classList.add("reading");
        else board.classList.remove("reading");
      }

      document.addEventListener("DOMContentLoaded", syncReadingMode);

      document.body.addEventListener("htmx:afterSwap", (e) => {
        if (e.target && e.target.id === "boardContent") {
          syncReadingMode();
        }
      });
    })();

    (function () {
      const wrap = document.querySelector(".wrap");
      if (!wrap) return;

      const mm = window.matchMedia("(max-width: 820px)");
      const boardEl = document.getElementById("board");
      const dimEl = document.getElementById("boardDim");
      const edgeEl = document.getElementById("boardSwipeEdge");
      if (!boardEl || !edgeEl) return;

      function isBoardOpen() {
        return wrap.classList.contains("has-board");
      }

      function ensureDimOn() {
        if (!dimEl) return;
        if (!mm.matches) return;
        if (isBoardOpen()) dimEl.classList.add("on");
      }

      function closeBoardTo(href) {
        const target = href || "/";
        
        // ✅ 스냅 닫기에서 남는 inline transform/transition 제거 (다음 오픈 대비)
        boardEl.style.transition = "";
        boardEl.style.transform = "";

        wrap.classList.add("closing");
        wrap.classList.remove("has-board");
        wrap.classList.add("no-board");
        wrap.dataset.hasBoard = "0";

        if (dimEl) {
          dimEl.style.opacity = "";
          dimEl.classList.remove("on");
        }

        setTimeout(() => {
          wrap.classList.remove("closing");

          if (window.DongriGoGlobe && typeof window.DongriGoGlobe.closeBoard === "function") {
            window.DongriGoGlobe.closeBoard({ href: target, loadHome: true, pushUrl: true });
            return;
          }

          window.location.href = target;
        }, 260);
      }

      // ✅ dim 클릭(탭)으로 닫기 (mobile only)
      if (dimEl) {
        dimEl.addEventListener("click", (e) => {
          if (!mm.matches) return;
          if (!isBoardOpen()) return;
          e.preventDefault();
        
          const w = boardEl.getBoundingClientRect().width || window.innerWidth;
        
          // 딤도 같이 페이드아웃
          if (dimEl) {
            dimEl.classList.add("on");
            dimEl.style.opacity = "0";
          }
        
          // 보드 스냅 닫기
          snapTo(w, 160);
        
          window.setTimeout(() => {
            resetDrag();      // dragging 상태가 아니어도 안전(정리용)
            closeBoardTo("/"); // closeBoardTo 내부에서 transform 초기화도 이미 추가했지
          }, 170);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        if (wrap.dataset.hasBoard === "1") {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              wrap.classList.remove("no-board");
              wrap.classList.add("has-board");
              ensureDimOn();
            });
          });
        }
      });

      // ✅ 보드가 “열리는” 일반 케이스에서도 딤 ON
      document.body.addEventListener("htmx:afterSwap", () => {
        ensureDimOn();
      });

      // ✅ 닫기는 js-close만
      document.addEventListener("click", (e) => {
        const close = e.target.closest && e.target.closest("a.js-close");
        if (!close) return;
        e.preventDefault();
        closeBoardTo(close.getAttribute("href") || "/");
      });

      // ✅ SWIPE CLOSE: edge에서만 이벤트 받기 (mobile only)
      let startX = 0, startY = 0, lastX = 0;
      let dragging = false;
      let started = false;

      // velocity tracking (최근 구간 속도)
      let prevX = 0;
      let prevT = 0;
      let lastV = 0; // px/ms

      function snapTo(x, ms) {
        boardEl.style.transition = `transform ${ms}ms ease`;
        boardEl.style.transform = `translateX(${x}px)`;
        window.setTimeout(() => {
          boardEl.style.transition = "";
        }, ms + 20);
      }

      function snapBack(ms) {
        boardEl.style.transition = `transform ${ms}ms ease`;
        boardEl.style.transform = `translateX(0px)`;
        window.setTimeout(() => {
          boardEl.style.transition = "";
          boardEl.style.transform = "";
        }, ms + 20);
      }

      // ✅ 상태 정리 전용 (중첩 함수 제거)
      function resetDrag() {
        dragging = false;
        started = false;
        wrap.classList.remove("dragging");
        if (dimEl) dimEl.style.opacity = "";
        ensureDimOn();
        lastV = 0;
      }

      edgeEl.addEventListener("pointerdown", (e) => {
        if (!mm.matches) return;
        if (!isBoardOpen()) return;

        started = true;
        dragging = false;

        startX = e.clientX;
        startY = e.clientY;
        lastX = startX;

        const t = performance.now();
        prevX = startX;
        prevT = t;
        lastV = 0;

        ensureDimOn();

        try { edgeEl.setPointerCapture(e.pointerId); } catch (_) {}
      });

      edgeEl.addEventListener("pointermove", (e) => {
        if (!mm.matches) return;
        if (!started) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        if (dx < 0) return; // 오른쪽만

        if (!dragging) {
          if (Math.abs(dx) < 10) return;
          if (Math.abs(dx) < Math.abs(dy) + 8) return; // 세로 스크롤 우선
          dragging = true;
          wrap.classList.add("dragging");
        }

        e.preventDefault();

        // velocity(최근 구간) 업데이트
        const nowT = performance.now();
        const nowX = e.clientX;
        const dt = Math.max(1, nowT - prevT);
        lastV = (nowX - prevX) / dt; // px/ms

        prevT = nowT;
        prevX = nowX;

        lastX = nowX;

        const w = boardEl.getBoundingClientRect().width || window.innerWidth;
        const clamped = Math.min(dx, w);
        boardEl.style.transform = `translateX(${clamped}px)`;

        // ✅ 딤 진행도 반영
        if (dimEl) {
          dimEl.classList.add("on");
          const t = Math.max(0, Math.min(1, clamped / w));
          const opacity = 0.35 * (1 - t);
          dimEl.style.opacity = String(opacity);
        }
      }, { passive: false });

      edgeEl.addEventListener("pointerup", () => {
        if (!mm.matches) return;
        if (!started) return;

        const dx = lastX - startX;
        const w = boardEl.getBoundingClientRect().width || window.innerWidth;

        const byDistance = dragging && dx > w * 0.25;
        const byVelocity = dragging && dx > 30 && lastV > 1.1;

        if (byDistance || byVelocity) {
          if (dimEl) {
            dimEl.classList.add("on");
            dimEl.style.opacity = "0";
          }
          snapTo(w, 160);

          window.setTimeout(() => {
            resetDrag();
            closeBoardTo("/");
          }, 170);
          return;
        }

        snapBack(180);
        window.setTimeout(() => {
          resetDrag();
        }, 190);
      });

      edgeEl.addEventListener("pointercancel", () => {
        if (!mm.matches) return;
        if (!started) return;
        snapBack(180);
        window.setTimeout(() => resetDrag(), 190);
      });
      
      // ✅ URL 기준으로 보드 상태 동기화 (뒤로가기/앞으로가기 대응)
      function isHomePath() {
        const p = window.location.pathname || "/";
        return p === "/";
      }
    
      function closeVisualOnly() {
        // 이미 닫혀있으면 스킵
        if (!isBoardOpen()) return;
    
        // 스냅/드래그에서 남을 수 있는 inline 제거
        boardEl.style.transition = "";
        boardEl.style.transform = "";
    
        wrap.classList.add("closing");
        wrap.classList.remove("has-board");
        wrap.classList.add("no-board");
        wrap.dataset.hasBoard = "0";
    
        if (dimEl) {
          dimEl.style.opacity = "";
          dimEl.classList.remove("on");
        }
    
        window.setTimeout(() => {
          wrap.classList.remove("closing");
        }, 260);
      }
    
      function openVisualOnly() {
        // 이미 열려있으면 스킵
        if (isBoardOpen()) return;
    
        wrap.classList.remove("no-board");
        wrap.classList.add("has-board");
        wrap.dataset.hasBoard = "1";
        ensureDimOn();
      }
    
      function syncBoardFromUrl() {
        // 홈이면 닫힘, 홈이 아니면 열림
        if (isHomePath()) closeVisualOnly();
        else openVisualOnly();
      }
    
      // htmx가 히스토리 복원할 때(Back/Forward) 확실히 잡기
      document.body.addEventListener("htmx:historyRestore", () => {
        // 복원 직후 URL 기준 동기화
        syncBoardFromUrl();
      });
    
      // 브라우저 popstate도 같이(보험)
      window.addEventListener("popstate", () => {
        syncBoardFromUrl();
      });
    
      // 첫 진입 상태도 URL로 한번 더 정리(보험)
      document.addEventListener("DOMContentLoaded", () => {
        syncBoardFromUrl();
      });
    })();
  </script>

  <!-- Board state manager -->
  <script src="{% static 'blog/js/board_state.js' %}"></script>

  <!-- ✅ Phase 2-5: Search UX (country keyboard + board recent searches) -->
  <script src="{% static 'blog/js/search_ux.js' %}"></script>

  <!-- Globe integration -->
  <script src="{% static 'blog/js/globe.js' %}"></script>
  <script src="{% static 'blog/js/lightbox.js' %}"></script>

  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div>
      <div class="lb-loading" aria-hidden="true">
        <div class="lb-spinner"></div>
      </div>

      <img id="lightboxImg" alt="" />
      <div class="hint" id="lightboxCap"></div>
    </div>
  </div>
</body>
</html>
