{% load cld highlight %}

{% if selected_country %}
  <div data-has-country="1" hidden></div>
  <div data-has-post="{% if selected_post %}1{% else %}0{% endif %}" hidden></div>

  <div class="board-sticky">
    <div class="board-header">
      <div>
        <h2 style="margin:0 0 8px 0; display:flex; align-items:center; gap:10px;">
          {% if selected_country.flag_image %}
            <img
              src="{{ selected_country.flag_image.url|cld_transform:'w_48,h_32,c_fill,q_auto,f_auto' }}"
              alt=""
              class="flag-img"
              loading="lazy"
              width="48"
              height="32"
              style="margin:0;"
            />
          {% elif selected_country.iso_a2 %}
            <span class="fi fi-{{ selected_country.iso_a2|lower }}" aria-label="{{ selected_country.name }}"></span>
          {% endif %}

          <span>{{ selected_country.name }}</span>

          {% if country_posts_total is not None %}
            <span class="hint" style="margin-left:6px;">({{ country_posts_total }})</span>
          {% endif %}
        </h2>
      </div>

      {# ✅ 닫기: js-close + href="/" 고정 #}
      <a class="close-btn js-close" href="/">닫기</a>
    </div>

    {% if selected_country.short_description %}
      <div class="hint">{{ selected_country.short_description }}</div>
    {% endif %}

    <div class="tabs">
      {% for key,label,cat_slug in tabs %}
        <a class="{% if selected_category == key %}active{% endif %}"
           href="/{{ selected_country.slug }}/{{ cat_slug }}/?page=1{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
           hx-get="/{{ selected_country.slug }}/{{ cat_slug }}/?page=1{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
           hx-target="#boardContent"
           hx-swap="innerHTML"
           hx-indicator=".htmx-indicator"
           hx-push-url="true">
          {{ label }}
        </a>
      {% endfor %}
    </div>

    {% if tag %}
      <div class="board-active-filters" aria-label="Active filters">
        {% if selected_tag %}
          <span class="tag-chip tag-chip--active">#{{ selected_tag.name }}</span>
        {% else %}
          <span class="tag-chip tag-chip--active">#{{ tag }}</span>
        {% endif %}
        <a class="hint"
           href="{{ category_path }}?page=1{% if q %}&q={{ q|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
           hx-get="{{ category_path }}?page=1{% if q %}&q={{ q|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
           hx-target="#boardContent"
           hx-swap="innerHTML"
           hx-indicator=".htmx-indicator"
           hx-push-url="true">태그 해제</a>
      </div>
    {% endif %}

    <div class="board-controls">
      <div class="board-search-wrap">
        <form class="search"
              action="{{ category_path }}" method="get"
              hx-get="{{ category_path }}"
              hx-target="#boardContent"
              hx-swap="innerHTML"
              hx-indicator=".htmx-indicator"
              hx-push-url="true"
              autocomplete="off">
          <input class="search-input" type="text" name="q" value="{{ q|default:'' }}"
                 placeholder="글 제목/본문 검색" />
          <input type="hidden" name="page" value="1" />
          {% if tag %}
            <input type="hidden" name="tag" value="{{ tag }}" />
          {% endif %}
          {% if sort and sort != 'new' %}
            <input type="hidden" name="sort" value="{{ sort }}" />
          {% endif %}
          <button class="search-btn" type="submit">검색</button>
        </form>

        <div class="search-suggest" data-search-suggest hidden aria-hidden="true">
          <div class="search-suggest__head">
            <span class="hint">최근 검색</span>
            <button class="search-suggest__clear" type="button" data-search-clear>지우기</button>
          </div>
          <div class="search-suggest__list" data-search-list></div>
        </div>
      </div>

      <form class="board-sort"
            action="{{ category_path }}" method="get"
            hx-get="{{ category_path }}"
            hx-target="#boardContent"
            hx-swap="innerHTML"
            hx-indicator=".htmx-indicator"
            hx-push-url="true">
        <input type="hidden" name="page" value="1" />
        {% if q %}
          <input type="hidden" name="q" value="{{ q }}" />
        {% endif %}
        {% if tag %}
          <input type="hidden" name="tag" value="{{ tag }}" />
        {% endif %}
        <label class="hint" for="boardSortSelect" style="white-space:nowrap;">정렬</label>
        <select id="boardSortSelect" name="sort" onchange="this.form.requestSubmit();">
          {% for v, label in sort_options %}
            <option value="{{ v }}" {% if sort == v %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </form>
    </div>

    {% if q %}
      <div style="margin-top:8px;">
        <a class="hint"
           href="{{ category_path }}?page=1{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
           hx-get="{{ category_path }}?page=1{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
           hx-target="#boardContent"
           hx-swap="innerHTML"
           hx-indicator=".htmx-indicator"
           hx-push-url="true">검색 해제</a>
      </div>
    {% endif %}
  </div>

  <div class="toc">
    {% for p in posts %}
      <a class="toc-link {% if selected_post and selected_post.slug == p.slug %}active{% endif %}"
         href="/{{ selected_country.slug }}/{{ selected_category_slug }}/{{ p.slug }}/?page={% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}{% if from_tags %}&src=tags&from_tag={{ from_tag|urlencode }}&from_page={{ from_page }}{% if from_q %}&from_q={{ from_q|urlencode }}{% endif %}{% endif %}"
         hx-get="/{{ selected_country.slug }}/{{ selected_category_slug }}/{{ p.slug }}/?page={% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}{% if from_tags %}&src=tags&from_tag={{ from_tag|urlencode }}&from_page={{ from_page }}{% if from_q %}&from_q={{ from_q|urlencode }}{% endif %}{% endif %}"
         hx-target="#boardContent"
         hx-swap="innerHTML"
         hx-indicator=".htmx-indicator"
         hx-push-url="true">
        {{ p.title|highlight:q }}
      </a>
    {% empty %}
      {% if q %}
        <div class="board-emptybox">
          <div class="board-emptytitle">검색 결과가 없습니다</div>
          <div class="hint">다른 키워드로 검색하거나, 검색을 해제해 보세요.</div>
          <div class="board-emptyactions">
            <a class="btn"
               href="{{ category_path }}?page=1{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-get="{{ category_path }}?page=1{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-target="#boardContent"
               hx-swap="innerHTML"
               hx-indicator=".htmx-indicator"
               hx-push-url="true">검색 해제</a>
          </div>
        </div>
      {% elif tag and tag_not_found %}
        <div class="board-emptybox">
          <div class="board-emptytitle">태그를 찾을 수 없습니다</div>
          <div class="hint">존재하지 않는 태그(slug)입니다.</div>
          <div class="board-emptyactions">
            <a class="btn"
               href="{{ category_path }}?page=1{% if q %}&q={{ q|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-get="{{ category_path }}?page=1{% if q %}&q={{ q|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-target="#boardContent"
               hx-swap="innerHTML"
               hx-indicator=".htmx-indicator"
               hx-push-url="true">태그 해제</a>
          </div>
        </div>
      {% else %}
        {% if country_posts_total == 0 %}
          <div class="board-emptybox">
            <div class="board-emptytitle">이 국가에는 아직 게시물이 없습니다</div>
            <div class="hint">관리자에서 Country / Post를 추가하면 여기에 표시됩니다.</div>
            <div class="hint" style="margin-top:6px;">(관리자) /admin → Post 추가</div>
          </div>
        {% elif category_posts_total == 0 %}
          <div class="board-emptybox">
            <div class="board-emptytitle">이 카테고리에는 아직 글이 없습니다</div>
            <div class="hint">다른 탭을 선택하거나, 관리자에서 글을 작성해 보세요.</div>
            <div class="hint" style="margin-top:6px;">(관리자) /admin → Post 추가</div>
          </div>
        {% else %}
          <div class="hint hint-pad">게시물이 없습니다.</div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>

  {% if selected_post %}
    <div class="pager">
      {% if from_tags and tags_back_url %}
        <a class="btn pager-back js-back"
           href="{{ tags_back_url }}"
           hx-get="{{ tags_back_url }}"
           hx-target="#boardContent"
           hx-swap="innerHTML"
           hx-indicator=".htmx-indicator"
           hx-push-url="true">목록</a>
      {% else %}
        <a class="btn pager-back js-back"
           href="{{ category_path }}?page={% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
           hx-get="{{ category_path }}?page={% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
           hx-target="#boardContent"
           hx-swap="innerHTML"
           hx-indicator=".htmx-indicator"
           hx-push-url="true">목록</a>
      {% endif %}

      {% if page_obj and page_obj.paginator.num_pages > 1 %}
        <div class="pager-nav">
          {% if page_obj.has_previous %}
            <a href="{{ category_path }}?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-get="{{ category_path }}?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-target="#boardContent" hx-swap="innerHTML"
               hx-indicator=".htmx-indicator" hx-push-url="true">이전</a>
          {% else %}
            <span class="hint">이전</span>
          {% endif %}

          <span class="hint">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

          {% if page_obj.has_next %}
            <a href="{{ category_path }}?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-get="{{ category_path }}?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-target="#boardContent" hx-swap="innerHTML"
               hx-indicator=".htmx-indicator" hx-push-url="true">다음</a>
          {% else %}
            <span class="hint">다음</span>
          {% endif %}
        </div>
      {% endif %}
    </div>

  {% elif page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="pager">
      <div class="pager-nav">
        {% if page_obj.has_previous %}
          <a href="{{ category_path }}?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
             hx-get="{{ category_path }}?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
             hx-target="#boardContent" hx-swap="innerHTML"
             hx-indicator=".htmx-indicator" hx-push-url="true">이전</a>
        {% else %}
          <span class="hint">이전</span>
        {% endif %}

        <span class="hint">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a href="{{ category_path }}?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
             hx-get="{{ category_path }}?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if tag %}&tag={{ tag|urlencode }}{% endif %}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
             hx-target="#boardContent" hx-swap="innerHTML"
             hx-indicator=".htmx-indicator" hx-push-url="true">다음</a>
        {% else %}
          <span class="hint">다음</span>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {% if selected_post %}
    <div class="content" id="postContent">
      <h3 style="margin:0 0 8px 0;">{{ selected_post.title }}</h3>

      {% if selected_post.tags.all %}
        <div class="post-tags" aria-label="Post tags">
          {% for t in selected_post.tags.all %}
            <a class="tag-chip"
               href="{{ category_path }}?page=1{% if q %}&q={{ q|urlencode }}{% endif %}&tag={{ t.slug|urlencode }}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-get="{{ category_path }}?page=1{% if q %}&q={{ q|urlencode }}{% endif %}&tag={{ t.slug|urlencode }}{% if sort and sort != 'new' %}&sort={{ sort|urlencode }}{% endif %}"
               hx-target="#boardContent"
               hx-swap="innerHTML"
               hx-indicator=".htmx-indicator"
               hx-push-url="true">#{{ t.name }}</a>
          {% endfor %}
        </div>
      {% endif %}

      {% if selected_post.cover_image %}
        <img
          src="{{ selected_post.cover_image.url|cld_transform:'w_760,c_limit,q_auto,f_auto' }}"
          data-full="{{ selected_post.cover_image.url|cld_transform:'w_1600,c_limit,q_auto,f_auto' }}"
          data-caption="{{ selected_post.title }}"
          alt="{{ selected_post.title }}"
          class="cover-img"
          loading="lazy"
        />
      {% endif %}

      {% if selected_post_html %}
        {{ selected_post_html|safe }}
      {% else %}
        {{ selected_post.content|linebreaks }}
      {% endif %}

      {% if gallery_images %}
        <div class="gallery">
          {% for img in gallery_images %}
            <figure class="gallery-item">
              <img
                src="{{ img.image.url|cld_transform:'w_760,c_limit,q_auto,f_auto' }}"
                data-full="{{ img.image.url|cld_transform:'w_1600,c_limit,q_auto,f_auto' }}"
                data-caption="{{ img.caption|default_if_none:'' }}"
                alt="{{ img.caption|default_if_none:'' }}"
                loading="lazy"
                style="width:100%; border-radius:10px;"
              />

              {% if img.caption %}
                <figcaption class="hint" style="margin-top:6px;">{{ img.caption }}</figcaption>
              {% endif %}
            </figure>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="hint" style="margin-top:12px;">목차에서 글 제목을 클릭하면 내용이 여기에 표시됩니다.</div>
  {% endif %}

{% else %}
  <div data-has-country="0" hidden></div>
  <div data-has-post="0" hidden></div>

  <div class="board-empty">
    <h2 style="margin:0 0 10px 0;">국가를 선택하세요</h2>
    <div class="hint">
      왼쪽 지구본에서 국가를 클릭하거나, 상단 검색창에서 국가명을 검색해 선택할 수 있습니다.
    </div>
    <div class="hint" style="margin-top:10px;">
      (관리자) 국가/게시물이 없다면 /admin에서 Country, Post를 먼저 추가하세요.
    </div>
  </div>
{% endif %}
