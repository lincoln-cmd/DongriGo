{% load cld %}

{% if selected_country %}
  {# 읽기모드 판별용 마커 (JS에서 data-has-post='1' 체크) #}
  <div data-has-post="{% if selected_post %}1{% else %}0{% endif %}" hidden></div>

  <div class="board-header">
    <div>
      <h2 style="margin:0 0 8px 0;">{{ selected_country.name }}</h2>
    </div>
    {# 닫기 버튼은 JS에서 .js-close만 잡도록 #}
    <a class="close-btn js-close" href="/">닫기</a>
  </div>

  {% if selected_country.flag_image %}
    <img
      src="{{ selected_country.flag_image.url|cld_transform:'w_96,h_64,c_fill,q_auto,f_auto' }}"
      alt=""
      class="flag-img"
      loading="lazy"
      width="96"
      height="64"
    />
  {% endif %}

  <div class="hint">{{ selected_country.short_description }}</div>

  {# 탭 #}
  <div class="tabs">
    {% for key,label,cat_slug in tabs %}
      <a class="{% if selected_category == key %}active{% endif %}"
         href="/{{ selected_country.slug }}/{{ cat_slug }}/?page=1{% if q %}&q={{ q|urlencode }}{% endif %}"
         hx-get="/{{ selected_country.slug }}/{{ cat_slug }}/?page=1{% if q %}&q={{ q|urlencode }}{% endif %}"
         hx-target="#board"
         hx-swap="innerHTML"
         hx-indicator=".htmx-indicator"
         hx-push-url="true">
        {{ label }}
      </a>
    {% endfor %}
  </div>

  {# 검색 #}
  <form class="search"
        action="{{ category_path }}" method="get"
        hx-get="{{ category_path }}"
        hx-target="#board"
        hx-swap="innerHTML"
        hx-indicator=".htmx-indicator"
        hx-push-url="true">
    <input class="search-input" type="text" name="q" value="{{ q|default:'' }}"
           placeholder="글 제목 검색" />
    <input type="hidden" name="page" value="1" />
    <button class="search-btn" type="submit">검색</button>
  </form>

  {% if q %}
    <div class="mt-8">
      <a class="hint"
         href="{{ category_path }}?page=1"
         hx-get="{{ category_path }}?page=1"
         hx-target="#board"
         hx-swap="innerHTML"
         hx-indicator=".htmx-indicator"
         hx-push-url="true">검색 해제</a>
    </div>
  {% endif %}

  {# 목차 #}
  <div class="toc">
    {% for p in posts %}
      <a class="toc-link {% if selected_post and selected_post.slug == p.slug %}active{% endif %}"
         href="/{{ selected_country.slug }}/{{ selected_category_slug }}/{{ p.slug }}/?page={% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}"
         hx-get="/{{ selected_country.slug }}/{{ selected_category_slug }}/{{ p.slug }}/?page={% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}"
         hx-target="#board"
         hx-swap="innerHTML"
         hx-indicator=".htmx-indicator"
         hx-push-url="true">
        {{ p.title }}
      </a>
    {% empty %}
      {% if q %}
        <div class="hint hint-pad">검색 결과가 없습니다.</div>
      {% else %}
        <div class="hint hint-pad">해당 카테고리에 게시된 글이 없습니다. /admin에서 Post를 작성하세요.</div>
      {% endif %}
    {% endfor %}
  </div>

  {# 페이저: 읽기모드면 "목록" + (필요 시) 이전/다음, 목록모드면 (필요 시) 이전/다음 #}
  {% if selected_post %}
    <div class="pager">
      <a class="close-btn pager-back"
         href="{{ category_path }}?page={% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}"
         hx-get="{{ category_path }}?page={% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}"
         hx-target="#board"
         hx-swap="innerHTML"
         hx-indicator=".htmx-indicator"
         hx-push-url="true">목록</a>

      {% if page_obj and page_obj.paginator.num_pages > 1 %}
        <div class="pager-nav">
          {% if page_obj.has_previous %}
            <a href="{{ category_path }}?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}"
               hx-get="{{ category_path }}?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}"
               hx-target="#board"
               hx-swap="innerHTML"
               hx-indicator=".htmx-indicator"
               hx-push-url="true">이전</a>
          {% else %}
            <span class="hint">이전</span>
          {% endif %}

          <span class="hint">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

          {% if page_obj.has_next %}
            <a href="{{ category_path }}?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}"
               hx-get="{{ category_path }}?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}"
               hx-target="#board"
               hx-swap="innerHTML"
               hx-indicator=".htmx-indicator"
               hx-push-url="true">다음</a>
          {% else %}
            <span class="hint">다음</span>
          {% endif %}
        </div>
      {% endif %}
    </div>

  {% elif page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="pager">
      <div class="pager-nav">
        {% if page_obj.has_previous %}
          <a href="{{ category_path }}?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}"
             hx-get="{{ category_path }}?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}"
             hx-target="#board"
             hx-swap="innerHTML"
             hx-indicator=".htmx-indicator"
             hx-push-url="true">이전</a>
        {% else %}
          <span class="hint">이전</span>
        {% endif %}

        <span class="hint">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a href="{{ category_path }}?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}"
             hx-get="{{ category_path }}?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}"
             hx-target="#board"
             hx-swap="innerHTML"
             hx-indicator=".htmx-indicator"
             hx-push-url="true">다음</a>
        {% else %}
          <span class="hint">다음</span>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {# 본문 #}
  {% if selected_post %}
    <div class="content" id="postContent">
      <h3 style="margin:0 0 8px 0;">{{ selected_post.title }}</h3>

      {% if selected_post.cover_image %}
        <img
          src="{{ selected_post.cover_image.url|cld_transform:'w_760,c_limit,q_auto,f_auto' }}"
          alt=""
          class="cover-img"
          loading="lazy"
        />
      {% endif %}

      {# ✅ 본문: Markdown 렌더링 결과 사용 (없으면 linebreaks fallback) #}
      {% if selected_post_html %}
        {{ selected_post_html|safe }}
      {% else %}
        {{ selected_post.content|linebreaks }}
      {% endif %}

      {# ✅ 본문 아래 갤러리(본문에 삽입된 것 제외한 나머지만) #}
      {% if gallery_images %}
        <div class="gallery">
          {% for img in gallery_images %}
            <figure class="gallery-item">
              <img
                src="{{ img.image.url|cld_transform:'w_760,c_limit,q_auto,f_auto' }}"
                alt="{{ img.caption|default_if_none:'' }}"
                loading="lazy"
              />
              {% if img.caption %}
                <figcaption class="hint">{{ img.caption }}</figcaption>
              {% endif %}
            </figure>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="hint mt-12">
      목차에서 글 제목을 클릭하면 내용이 여기에 표시됩니다.
    </div>
  {% endif %}
{% endif %}
